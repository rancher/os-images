#!/bin/bash
set -e

export ARCH=${ARCH:-"amd64"}

cd $(dirname $0)/..

DO_PUSH="$1"

set -a
. build.conf
[ "${ARCH}" == "amd64" ] || . ./.${ARCH}.docker-env
set +a

SUFFIX=""
[ "${ARCH}" == "amd64" ] || SUFFIX="_${ARCH}"

if [ "${DO_PUSH}" == "--push" ]; then
    for i in src/docker/[0-9]*; do
        name="os-$(echo ${i} | cut -f2 -d-)"
        tag="${OS_IMAGES_ROOT}/${name}:${VERSION}${SUFFIX}"
        echo Pushing ${tag}
        docker push ${tag} || :
    done
else
    for i in src/docker/[0-9]*; do
        name="os-$(echo ${i} | cut -f2 -d-)"
        tag="${OS_IMAGES_ROOT}/${name}:${VERSION}${SUFFIX}"
        echo Building ${tag}
        if [ -x ${i}/.prebuild.sh ]; then
            ${i}/.prebuild.sh;
        fi
        if [ -f ${i}/Dockerfile.${ARCH} ]; then
            docker build -t rancher/${name} -f ${i}/Dockerfile.${ARCH} ${i}
        else
            docker build -t rancher/${name} ${i}
        fi
        docker tag rancher/${name} ${tag}
    done
fi
